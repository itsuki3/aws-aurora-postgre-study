# Amazon Redshift ハンズオン - Day2

# 1. 環境構築準備
## 1-1. ハンズオンで利用するアカウント
* AWSプロフェッショナルサービスにて用意した以下のアカウントをご利用下さい。

|no.|アカウントID|管理者|
|---:|:---|:---|
|1||AWS仲谷|
|2||AWS仲谷|
|3||AWS仲谷|
|4||AWS関口|
|5||AWS関口|
|6||AWS関口|

* IAMユーザー名、パスワード、アカウントIDは当日お知らせします。
* ハンズオンでは **東京リージョン** をご利用ください。

## 1-2. CloudFormationによるハンズオン環境の構築
* 今回は事前にVPCとRedshift、Aurora PostgreSQL環境を構築済みです。
* 今回使用するSQL等は、本マークダウン中から直接コピーして下さい。

## 1−3. スナップショットの復元
* 事前にクラスター作成、テーブル作成、データロードを完了済みのクラスターから取得したスナップショットを使って、各自のAWSアカウントにRedshiftクラスターを復元します。
  * スナップショットを選択
  * 以下のスナップショットを選択
```
スナップショット名　：　TBD
```
* 完了までしばらく待ちます。

# 2. 接続確認

## 2-1. データベースへの接続確認
### 2-2-1 接続設定の作成
* PC上にインストールされている、Aginity Workbench for Redshift（以下Aginity）を起動します。
* 接続情報を以下の通り入力します。
* Redshiftクラスターエンドポイントはコンソールから確認し、コピペして下さい。

```
Name      : （任意）
Server    : （クラスターエンドポイントのURL。ポートを除く）
DB Port   : 5439
SSL Mode  : Prefer
User ID   : awsuser
Password  : （上記で入力したパスワード）
```

### 2-2-2 接続テスト
* 入力した接続情報に基づいて、実際にRedshiftクラスターに接続します。
* 接続したら、Aginityからawsuser.mydbスキーマをクリックし、pg_catarogデータベースをざっと外観してみて下さい。

# 3. ハンズオン
* ここでは、Redshiftチューニングやトラブルシューティングについてハンズオンを行っていきます。
  * **sh1**という1,500万件ほどの小型のスキーマをサンプルに使っていきます。

## 3-1. WLM実習
* 「ワークロード管理」→「WLM」から、当該クラスター用のWLM設定を作成します。

### 3-1.1. WLM関連ビューの作成

### 3-1.2. WLMキューの作成と設定

### 3-1.3. QMRルールの作成と設定


## 3-2. クエリーの実行
* SQLを実行し、sh1スキーマに投入したデータを確認します。

### 3-2-1. TBD

### 3-3. 圧縮エンコーディング実習
* TBD

### 3-4. ソートキー実習
* TBD

### 3-5. 分散キー実習
* TBD

### 3-6. トラシュー実習
* TBD

# 4. ハンズオン環境の削除
* Redshiftハンズオン環境の削除は弊社にて行います。そのままにしておいていただいて結構です。
***

# Amazon Aurora PostgreSQL ハンズオン - Day2

# 4. 環境構築準備
  * **本ハンズオンでは環境は事前に作成済です。**
  * **マスターユーザー名及びパスワード等は別途おしらせします。**
  * **コンソール右上で「東京」リージョンが選択されていることだけ、再度ご確認下さい。**


## 4.1 クライアントの接続設定
  * Psqleditを利用される場合は以下の接続設定を行なってください。
  * psql等のcliツールを利用される場合は、事前にお知らせしたマスターパスタワード及び、読み込みエンドポイントとクラスターエンドポイント、各レプリカのインスタンスエンドポイントをメモ帳へコピーしておいてください。

  * **HOSTに設定するクラスターエンドポイント及び、読み込みエンドポイントの確認方法は以下の通りです。**
    * 「サービス」→「RDS」→「クラスター」→「DBクラスター識別子」以下の該当クラスターのリンク→「詳細」ペインから確認できます。

  * **各レプリカのインスタンスエンドポイントの確認方法は以下の通りです。**
    * 「サービス」→「RDS」→「クラスター」→「クラスターメンバー」ペイン → 「ロール」列が **読み込み** となっている「dbインスタンス」列のリンクをクリック → 「接続」ペインから確認できます。

  **読み込みエンドポイント向け接続設定**
  ```
  USER    : awsuser
  PASS    : 本日お知らせしたマスターパスワード
  DBNAME  : mydb
  HOST    : 事前作成されているap96clusterの読み込みエンドポイント
  PORT    : 5432
  OPTION  : 未入力
  NAME    : 読み込みエンドポイント
  ```
  * 上記を入力後→「Add」ボタン→「OK」ボタンをクリック

  **クラスターエンドポイント向け接続設定**
  ```
  USER    : awsuser
  PASS    : 本日お知らせしたマスターパスワード
  DBNAME  : mydb
  HOST    : 事前作成されているap96clusterのクラスターエンドポイント
  PORT    : 5432
  OPTION  : 未入力
  NAME    : クラスターエンドポイント
  ```
  * 上記を入力後→「Add」ボタン→「OK」ボタンをクリック

  * **各レプリカ向けインスタンスエンドポイントの接続設定**
    * **便宜上、レプリカ1、レプリカ2と記載していますが、2つあるレプリカのうちどちらを1,2にしても構いません。**
  **レプリカ1のインスタンスエンドポイント向け接続設定**
  ```
  USER    : awsuser
  PASS    : 本日お知らせしたマスターパスワード
  DBNAME  : mydb
  HOST    : 1つめのレプリカを指すインスタンスエンドポイント
  PORT    : 5432
  OPTION  : 未入力
  NAME    : レプリカ2エンドポイント
  ```
  * 上記を入力後→「Add」ボタン→「OK」ボタンをクリック

  **レプリカ2のインスタンスエンドポイント向け接続設定**
  ```
  USER    : awsuser
  PASS    : 本日お知らせしたマスターパスワード
  DBNAME  : mydb
  HOST    : 2つめのレプリカを指すインスタンスエンドポイント
  PORT    : 5432
  OPTION  : 未入力
  NAME    : レプリカ2エンドポイント
  ```
  * 上記を入力後→「Add」ボタン→「OK」ボタンをクリック

## 4.2 接続テスト  
  * psql等cliを利用している場合は、メモ帳等にコピーしておいた情報を元に4つのエンドポイントへ接続できるかを確認してください。
  * **作成したクラスターエンドポイント接続設定** 、 **読み込みエンドポイント向け接続設定** 、**レプリカ１エンドポイント向け接続設定** 、ぞれぞれ設定で各エンドポイントに接続できるか確認します。
  * 以下の操作で残りの接続設定の確認を行います。（アプリケーション画面上部等に接続先設定のNAMEで指定した名称が表示されていることを確認してください）
    * Psqleditのメニュー →「ファイル」→「接続先の変更」→「login」ダイアログの「接続先の選択」ペインから 接続確認する接続設定 をダブルクリック

  * 以下のクエリーを「SQL編集」ペインへ入力後 ▶︎(SQL実行ボタン)をクリックし正常に実行されるか確認してください。
  ```
  select version();
  ```
  以下の結果が返されます。
  ```
  version                                    
  ------------------------------------------------------------------------------
  PostgreSQL 9.6.8 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.9.3, 64-bit
  ```
  * **4つのエンドポイントへ接続できれば接続確認は終了です。**


# 5. ハンズオン
* Aurora PostgreSQLクラスターを利用した運用監視、チューニングなどのトラブルシューティングを体験していだだきます。

## 5-1. Auto Scaling
* レプリカに一定の負荷をかけScale out / Scale inを体験していただきます。(CloudWatch Dashboardの作成及び、イベントサブスクリプションe-mailの設定含む)
**TBD Auto Scalingの設定〜Scale out / Scale inまで。**


** ここで座学に戻ります **
## 5-2. Failover
* フェイルオーバーの優先度の確認後、フェイルオーバーを発生させ、フェイルオーバー完了までの時間やフェイルオーバー先の制御を体験していただきます。
**TBD 優先度は事前に設定しておくフェイルオーバー時間を確認させるかは未定。**

** ハンズオンPart.1はここで終了です。早めに終了した方は休憩していただいて結構です。**


## 5-3. Performance Insights (日本語訳はパフォーマンスインサイトになっていますが、最後のsは大切です)
* Performance Insightsを利用した分析及び、チューニングを体験していただきます。
**TBD チューニング例を数件(2〜3)用意しておき、参加者の状況に応じて進めてもらう感じで。**
**TBD 参加者の傾向（現在利用しているDB)により、さらにオプションのチューニング例を追記するかもしれない。**

## お疲れ様でした。これでハンズオンは終了です。
## **ハンズオン環境の削除等はこちらで行います。そのままにしておいていただいて結構です。**
