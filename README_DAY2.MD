# Amazon Redshift ハンズオン - Day2

# 1. 環境構築準備
## 1-1. ハンズオンで利用するアカウント
* AWSプロフェッショナルサービスにて用意した以下のアカウントをご利用下さい。詳細はハンズオン開始時にお知らせします。

|no.|アカウントID|管理者|
|---:|:---|:---|
|1||AWS仲谷|
|2||AWS仲谷|
|3||AWS仲谷|
|4||AWS関口|
|5||AWS関口|
|6||AWS関口|

* IAMユーザー名、パスワードは当日お知らせします。
* ハンズオンでは **東京リージョン** をご利用ください。

## 1-2. CloudFormationによるハンズオン環境の構築
* 今回は事前にVPCとRedshift、Aurora PostgreSQL環境を構築済みです。
* 今回使用するSQL等は、本マークダウン中から直接コピーして下さい。

## 1−3. スナップショットの復元
* 事前にクラスター作成、テーブル作成、データロードを完了済みのクラスターから取得したスナップショットを使って、各自のAWSアカウントにRedshiftクラスターを復元します。
  * スナップショットを選択
  * 以下のスナップショットを選択
```
スナップショット名　：　TBD
```
* 完了までしばらく待ちます。

# 2. 接続確認

## 2-1. データベースへの接続確認
### 2-2-1 接続設定の作成
* PC上にインストールされている、Aginity Workbench for Redshift（以下Aginity）を起動します。
* 接続情報を以下の通り入力します。
* Redshiftクラスターエンドポイントはコンソールから確認し、コピペして下さい。

```
Name      : （任意）
Server    : （クラスターエンドポイントのURL。ポートを除く）
DB Port   : 5439
SSL Mode  : Prefer
User ID   : awsuser
Password  : （上記で入力したパスワード）
```

### 2-2-2 接続テスト
* 入力した接続情報に基づいて、実際にRedshiftクラスターに接続します。
* 接続したら、Aginityからawsuser.mydbスキーマをクリックし、pg_catarogデータベースをざっと外観してみて下さい。

# 3. ハンズオン
* ここでは、Redshiftチューニングやトラブルシューティングについてハンズオンを行っていきます。
  * **sh1**という1,500万件ほどの小型のスキーマをサンプルに使っていきます。

## 3-1. WLM実習
* 「ワークロード管理」→「WLM」から、当該クラスター用のWLM設定を作成します。

### 3-1.1. WLM関連ビューの作成

### 3-1.2. WLMキューの作成と設定

### 3-1.3. QMRルールの作成と設定


## 3-2. クエリーの実行
* SQLを実行し、sh1スキーマに投入したデータを確認します。

### 3-2-1. TBD

### 3-3. 圧縮エンコーディング実習
* TBD

### 3-4. ソートキー実習
* TBD

### 3-5. 分散キー実習
* TBD

### 3-6. トラシュー実習
* TBD

# 4. ハンズオン環境の削除
* Redshiftハンズオン環境の削除は弊社にて行います。そのままにしておいていただいて結構です。
***

# Amazon Aurora PostgreSQL ハンズオン - Day2

# 4. 環境構築準備
* 本ハンズオンでは不要です。
* **コンソール右上で「東京」リージョンが選択されていることだけ、再度ご確認下さい。**

# 5. ハンズオン
* Aurora PostgreSQLクラスターの作成および基本的な操作を体験していただきます。

## 5-1. Aurora PostgreSQLクラスターの作成
* 「サービス」→「RDS」→「クラスター」→「データベースの作成」ボタン→「エンジンの選択」
→「Amazon Aurora」ラジオボタン→「PostgreSQL対応」ラジオボタン→「次へ」ボタンをクリックして「DB 詳細の指定」画面へ、各ペインで以下を設定・入力

* **特に入力・選択指示のない入力・選択項目は、設定されている値のままとしてください**

**インスタンスの仕様**
```
DBエンジンのバージョン : Aurora PostgreSQL (compatible with PostgreSQL 9.6.8)
DBインスタンスクラス : db.r4.large - 2 vcpu, 15.25 GiB RAM
マルチ AZ 配置 : 異なるゾーンにレプリカを作成
```

**設定**
```
DBインスタンス識別子 : ap96XXXXX (XXXXXは任意の文字列、3~5文字程度)を入力
マスターユーザの名前 : awsuser
マスターパスワード : xxxxxx （入力したパスワードは忘れないようご注意ください）
パスワードの確認　 : xxxxxx （マスターパスワードに同じ）
```
「次へ」ボタンをクリックし、「[詳細設定] の設定」へ

**[詳細設定] の設定**
```
Virtual Priavate Cloud (VPC) : デフォルト VPC
サブネットグループ : default
パブリックアクセシビリティ : はい
アベイラビリティゾーン : ap-northeast-1a
VPC セキュリティグループ : 新規の VPC セキュリティグループ を作成
```

**データベースの設定**
```
DBクラスター識別子 : ap96cXXXXX (XXXXXは任意の文字列、3~5文字程度)
データベースの名前 : mydb
ポート : 5432
DB パラメータグループ : default.autora-postgresql9.6
DB クラスターのパラメータグループ : default.autora-postgresql9.6
```

**暗号化**
```
暗号化 : 暗号を有効化
マスターキー : (default)aws/rds
```

**フェイルオーバー**
```
  優先度 : 範囲-2
```

**拡張モニタリング**
```
拡張モニタリング : 拡張モニタリングを有効にする
モニタリングロール : デフォルト
詳細度 : 60秒
```

**パフォーマンスインサイト**
```
パフォーマンスインサイトの有効化 : オン (ラジオボタンを選択)
保持期間 : デフォルト(7日)
マスターキー : (default)aws/rds
```

**削除保護**
```
削除保護の有効化 : オフ (チェックボックスを外す)
```

* 「データベースを作成」ボタン→「DBインスタンスの詳細表示」ボタンをクリック→サイトバーの「インスタンスタブ」リンクをクリックし、インスタンスペインへ
  * インスタンスタブで2つのDBインスタンスのステータスが **"作成中"** から **"利用可能"** に変化するまで待ちます。（10分程度）

* 各DBインスタンス名のリンクをクリックして、詳細情報を確認してみてください。
  * Replicationペインでは、2つのDBインスタンスが、書き込み(Writer)であるか、読み込み(Reader)であるか確認することができます。また、各DBインスタンスのエンドポイント等も確認することができます。

* 「サービス」→「RDS」→サイドバーの「クラスター」→「クラスター」タブに移動します。
* クラスターが作成され、「状況」が **"利用可能"** になっていることを確認します。
* 作成されているDBクラスター識別子のリンクをクリックして、クラスターの詳細情報を確認してみてください。
  * クラスターエンドポイント、読み込みエンドポイント等の詳細情報を確認できます。
  * 確認したエンドポイントをメモ帳などにコピーしておいてください。接続設定の作成で利用します。

### 5-1-2. アクセス元の制限

* 「サービス」→「RDS」→「インスタンス」→「インスタンス」ペイン →「DBインスタンス」にリストされている2つのDBのいずれか一つのリンクをクリック
  * スクロールダウンして「詳細」ペイン →「セキュリティグループ」のActive状態のセキュリティグループのリンクをクリック
  * 「EC2」ダッシュボード → 「セキュリティグループ」ペイン　→ 「インバウンド」タブ → 「編集」ボタン をクリック
  * 「インバウンドのルールの編集」ダイアログ → 「タイプ」が"PostgreSQL"となっているルールの「ソース」列 → 「マイIP」→ 「保存」ボタンをクリック

* **この操作で、Aurora PostgreSQLの各インスタンスは、現在操作中のPCのIPアドレスからのアクセスのみ受け付けるようになります**


## 5-2. データベースへの接続確認
### 5-2-1 接続設定の作成
* PC上にインストールされている **Psqledit** を起動します。 **クラスターエンドポイント向け接続設定** と **読み込みエンドポイント向け接続設定** の２つの設定を作成してください。
  * 接続設定に必要な情報は以下の通りです。

* **以下の手順で接続設定を定義します**
  * Psqledit起動 →「ログイン」ダイアログ →「ログイン情報の設定」ボタン →「ログイン情報」ダイアログ

* **HOSTに設定するクラスターエンドポイント及び、読み込みエンドポイントの確認方法は以下の通りです。**
  * 「サービス」→「RDS」→「クラスター」→「DBクラスター識別子」以下の該当クラスターのリンク→「詳細」ペインから確認できます。

**読み込みエンドポイント向け接続設定**
```
USER    : awsuser
PASS    : 5-1. Aurora PostgreSQLクラスターの作成"で設定した「マスターパスワード」
DBNAME  : 5-1. Aurora PostgreSQLクラスターの作成"で設定した「データベースの名前」
HOST    : 5-1. Aurora PostgreSQLクラスターの作成"で確認した読み込みエンドポイント
PORT    : 5432
OPTION  : 未入力
NAME    : 読み込みエンドポイント
```
  * 上記を入力後→「Add」ボタン→「OK」ボタンをクリック

**クラスターエンドポイント向け接続設定**
```
USER    : awsuser
PASS    : 5-1. Aurora PostgreSQLクラスターの作成"で設定した「マスターパスワード」
DBNAME  : 5-1. Aurora PostgreSQLクラスターの作成"で設定した「データベースの名前」
HOST    : 5-1. Aurora PostgreSQLクラスターの作成"で確認したクラスターエンドポイント
PORT    : 5432
OPTION  : 未入力
NAME    : クラスターエンドポイント
```
  * 上記を入力後→「Add」ボタン→「OK」ボタンをクリック


### 5-2-2 接続とテスト
* **作成したクラスターエンドポイント接続設定** と **読み込みエンドポイント向け接続設定** 、ぞれぞれ設定で各エンドポイントに接続できるか確認します。
* 以下の操作で残りの接続設定の確認を行います。（アプリケーション画面上部等に接続先設定のNAMEで指定した名称が表示されていることを確認してください）
  * Psqleditのメニュー →「ファイル」→「接続先の変更」→「login」ダイアログの「接続先の選択」ペインから **読み込みエンドポイント向け接続設定** をダブルクリック


* 以下のクエリーを「SQL編集」ペインへ入力後 ▶︎(SQL実行ボタン)をクリックし正常に実行されるか確認してください。
```
select version();
```

* 以下操作でアプリケーション画面上部等に接続先設定のNAMEで指定した名称が表示されていることを確認してください。
  * Psqleditの「login」ダイアログの「接続先の選択」ペインから作成した　**クラスターエンドポイント接続設定**　を選択 →「OK」ボタンをクリック→「SQL編集」ペイン

* 以下のクエリーを「SQL編集」ペインへ入力後 ▶︎(SQL実行ボタン)をクリックし正常に実行されるか確認してください。
```
select version();
```

* **これで接続確認は終了です。**


## 5-3. クラスターエンドポイントからの接続
* 5-2-1 で作成したクラスターエンドポイント接続設定を利用して接続し、以下の操作を行います。
  * 以下のコマンド、DDL、SQL文を実行し、クラスターエンドポイントから表作成、データ登録など書き込み操作が行えることを確認します。書き込み操作の確認が済んだらデータベースからdisconnectします。
```
create schema hoge;
set search_path=hoge;
select current_schema();
create table foobar (
  id numeric not null primary key
  ,name character(20) not null
  ,description character varying(40)
);
insert into foobar values(1,'test','test insertion');
select * from foobar;
```

## 5-4. 読み込みエンドポイントからの接続
* 2-2-1で作成した読み込みエンドポイント接続設定を利用して接続し、以下の操作を行います。
  * **以下のクエリーを実行してみてください。何が起こりましたか？**
```
select current_schema();
set search_path=hoge;
select current_schema();
select * from foobar;
```

  * **以下のクエリーを実行してみてください。何が起こりましたか？**
```
insert into foobar values(1,'test','test insertion');
```
* 読み込みエンドポイントへの接続時は、読み込み操作しか行えません。


## 5-5. スナップショットの取得
* Redshift同様、手動でスナップショットを取得します。
* 手動で取得したスナップショツトはデータベースを完全に削除した場合でも削除されません。

* 「サービス」→「RDS」→「サイドバー」の「 インスタンス」→ DBインスタンのロールが **書き込み** となっているDBインスタンス名横のラジオボタンをクリック →「インスタンスの操作」ドロップダウンメニュー →「スナップショットの取得」を選択して「DBスナップショットの取得」ペインへ
  * DBインスタンのロールが **書き込み** であることを確認するには、「サイドバー」→ 「クラスター」→ 「クラスターDB識別子」列下のDBクラスター名のリンク → 「DB クラスターメンバー」ペインのロール列を参照します
```
スナップショット名　: handson-aurora-snapshot
```
* 「スナップショットの取得」ボタンをクリック

* スナップショットの取得の完了を待っている間に、次のステップに進みます。


## 5-6. レプリカの追加
* **特に入力・選択指示のない入力・選択項目は、設定されている値のままとしてください**

* 「サイドバー」→「インスタンス」→ DBインスタンのロールが **書き込み** となっているDBインスタンス名横のラジオボタンをクリック →「インスタンスの操作」ドロップダウンメニュー →「Auroraレプリカの作成」画面へ

* DBインスタンのロールが **書き込み** であることを確認するには、「サイドバー」→ 「クラスター」→ 「クラスターDB識別子」列下のDBクラスター名のリンク → 「DB クラスターメンバー」ペインのロール列を参照します。

**ネットワーク & セキュリティ**
  * 「インスタンス」→ 「インスタンス」ペインのDBインスタンス列以下にリストされている2つのDBインスタンスのリンクをそれぞれクリック
    * 「詳細」ペインのアベイラビリティーゾーンを確認し、2つのDBインスタンスが配置されているアベイラビリティーゾーン以外を選択してください。
    * 例えば、2つのDBインスタンスが、それぞれ、 **ap-northeast-1a** と **ap-northeast-1d** に配置されたいた場合、 **ap-northeast-1c** を選択してください

```
アベイラビリティーゾーン : 既存DBインスタンが配置されていないアベイラビリティーゾーン
パブリックアクセス可能　 : はい
```
* **可用性向上のためには適切なアベイラビリティーゾーンを選択する必要があります。**


**インスタンスの仕様**
```
DB インスタンスのクラス : db.r4.large - 2 vcpu, 15.25 GiB RAM
```

**設定**
```
Aurora レプリカのソース : DBインスタンのロールが **書き込み** となっているDBインスタンス
DB インスタンス識別子　 : aup96-handson-replica2
```

**フェイルオーバー**
```
優先度 : 範囲-1
```

**モニタリング**
```
拡張モニタリング : 拡張モニタリングを有効にする
モニタリングロール : デフォルト
詳細度 : 60秒
```

**パフォーマンスインサイト**
```
パフォーマンスインサイトの有効化 : オン (ラジオボタンを選択)
保持期間 : デフォルト(7日)
マスターキー : (default)aws/rds
```
* 「Auroraレプリカの作成」をクリック

* 追加作成したレプリカのステータスが、 **”利用可能”** に変わるのを待ちます。（6分程度）
* レプリカのステータスが **"利用可能"**　に切り替わったら、5-5. で取得したスナップショット **"handson-aurora-snapshot"** のステータスが **利用可能** となっていことを確認
  * 「サイドバー」→「スナップショット」

* 追加したDBインスタンス"aup96-handson-replica2"がレプリカリストに追加され、ロールが **"読み込み"** となっていることを確認
  * 「サイドバー」→「クラスター」→「クラスター」ペイン→「DBクラスター識別子」のリンクをクリック →「DBクラスターメンバー」ペイン
  * レプリカ作成完了を待たずに、次のステップへ進みます。


## 5-7. リストア
* 5-5. で取得したスナップショットを元に復元(リストア)します。
  * **リストア操作では、新規DBクラスターが作成されます。また、既存DBインスタンス識別子は利用できません（既に削除されたDBインスタンス識別子は指定可能です）**
  * **特に入力・選択指示のない入力・選択項目は、設定されている値のままとしてください**

* 「サイドバー」→「スナップショット」→ 5-5.で取得したスナップショットのチェックボックをクリック →「スナップショットのアクション」ドロップダウンメニュー →「スナップショットの復元」　→　「DB インスタンスの復元」画面へ

**インスタンスの仕様**
```
DB エンジン : Aurora (PostgreSQL)
DB インスタンスのクラス : db.r4.large - 2 vcpu, 15.25 GiB RAM
```

**設定**
```
DB インスタンス識別子 : ap96rXXXXX (XXXXXは任意の文字列、3~5文字程度)を入力
```

**ネットワーク & セキュリティ**
```
Virtual Private Cloud (VPC) : デフォルトVPC
サブネットグループ : default
パブリックアクセシビリティ : はい
アベイラビリティーゾーン : ap-northeast-1a
```

**データベースの設定**
* DBパラメータグループ、DBクラスターのパラメータグループをカスタマイズしている場合にはカスタマイズ済みのパラメータグループを選択する必要があります。
```
データベースのポート : 5432
DB パラメータグループ : default.autora-postgresql9.6
DB クラスターのパラメータグループ : default.autora-postgresql9.6
```
* 「DBインスタンスの復元」ボタンをクリック
  * 復元したDBインスタンスがのステータスが **利用可能** になるまで少々時間（15分程度）を要します。復元が開始されたことを確認後、次のステップに進んで下さい。

* スナップショットから復元されるDBインスタンスは1インスタンス（DBインスタンのロールは **書き込み** となるプライマリーインスタンス）のみを含むクラスターが復元されるため、必要に応じレプリカを追加する必要があります。

## 5-8. オプション - 手動フェイルオーバーの確認（時間に余裕のある場合）
* 手動フェイルオーバーさせ、レプリカ（DBインスタンのロールが **読み込み** )を、プライマリインスタンス（DBインスタンのロールが **書き込み** ）へ昇格させます。
  * 「サイドバー」→「クラスター」→「DBクラスター識別子」列下のDBクラスター名( **ap96c** で始まるDBクラスター)のハイパーリンク → 「DB クラスターメンバー」ペインの「ロール」列
    * 各DBインスタンスのロールが、**読み込み** （レプリカ）なのか **書き込み** (プライマリーインスタンス)であるかを確認します。
    * DBインスタンス名のハイパーリンクをクリック → 「詳細」ペインの「フェイルオーバー優先順位」を確認
      * 「Replication」ペイン → DBインスタンス名のハイパーリンクをクリック → 他のDBインスタンスの「詳細」ペインの「フェイルオーバー優先順位」を確認

      * 「フェイルオーバー優先順位」が　**2** のDBインスタンスが **2つ** あります。(DBインスタンスのロールが、**読み込み** と **読み込み** それぞれ 1インスタンス)
      * 「フェイルオーバー優先順位」が　**1** のDBインスタンスが **1つ** あります。( **5-6. レプリカの追加** で追加したレプリカ）

    * 「詳細」ペインの「フェイルオーバー優先順位」を参照している画面上部の「インスタンス操作」メニュー → 「フェイルオーバー」→ 「Failover DB Cluster」画面 → 「フェイルオーバー」ボタン
      * 「サイドバー」→「クラスター」→「DBクラスター識別子」列下のDBクラスター名のハイパーリンク → 「DB クラスターメンバー」ペイン → 「更新」ボタン
        * **5-6. レプリカの追加**　で追加したレプリカのロールが、**書き込み** となったことを確認してください。
        * 「最近のイベント」ペインに以下のようなイベントが記録されていることも確認してください。
```
Completed failover to DB instance: ap96XXXX-replica2
Started cross AZ failover to DB instance: ap96XXXX-replica2
```  


## 5-9. クラスターの停止
* クラスターの停止・開始機能のリリースにより、開発環境など利用しない時間帯にクラスターの停止開始の代替操作としてのクラスターの削除、リストア、レプリカ追加という煩雑な操作は不要になりました。
  * **"5-1. Aurora PostgreSQLクラスターの作成"** で作成した **"ap96c"** で始まるDBクラスター識別子を持つクラスター(3 DBインスタンス)を **停止** します。

  * 「サイドバー」→「クラスター」→ "ap96c" で始まるDBクラスター識別子横にあるラジオボタンをクリック →「クラスターアクション」→「停止」→「データベースの停止」ボタンをクリック

* Amazon RDSも含めインスタンスの停止は可能ですが、停止可能な期間は7日間です。8日後には自動的に再起動します。
* クラスターの状況が **"停止中"** から **"停止"** になるまでしばらく待ちます。（12分程度）


## 5-10. クラスターの開始
* 「サイドバー」→「クラスター」→ "ap96c" で始まるDBクラスター識別子横にあるラジオボタンをクリック →「クラスターアクション」→「開始」を選択
  * クラスターの状況が **"開始中"** から **"利用可能"** になるまでしばらく時間を要します。（15分程度）

* クラスターの開始を待つ間に、リストアで作成したクラスターを削除します。次のステップへ進んでください。


## 5-11. クラスター内の全DBインスタンスの削除（兼　環境クリーンアップ）
* DBインスタンスを削除します。
  * 最初に **"ap96r"** で始まるクラスター（リストアで作成したクラスター）のDBインスタンスを削除します。

* 「サイドバー」→「インスタンス」→　"ap96r" で始まるDBインスタンス横にあるラジオボタンをクリック → 「インスタンスの操作」メニュー → 「削除」→「最終スナップショットを作成しますか？」ダイアログへ

**最終スナップショットを作成しますか？**
```
最終スナップショットを作成しますか? : いいえ
インスタンスの削除後、システムスナップショットとポイントインタイムの復元を含む自動バックアップが利用不可となることを了承しました。 : チェックボックスをチェック
削除を確認するには、delete me というフレーズを以下のフィールドに入力します : delete me
```
* 「削除」ボタンをクリック
  * "ap96r" で始まるDBインスタンスのステータスが **"削除中"** に変わります。

* **ここで、DBインスタンス削除操作を止めてください。 5-10. クラスターの開始で開始中のクラスターが起動するのを待ちます**
  * 5-10. クラスターの開始起動中のDBインスタンス全てのステータスが **"利用可能"** となった後、以下の操作を行います。
  * 順序は決まっていませんが、本ハンズオンでは、インスタンス画面のDBインスタンス列にリストされているDBインスタンスを上位から順に削除します。

* 「サイドバー」→「インスタンス」→　DBインスタンス横のラジオボタンをクリック → 「インスタンスの操作」メニュー →「削除」→ 「XXXXX インスタンス を削除しますか?」ダイアログへ
  * DBクラスターに含まれる 3 DBインスタンスのうち最初の 2 DBインスタンスの削除ダイアログでは、**delete me** という削除キーワードのみ入力します。
```
DB インスタンス XXXXX を削除してよろしいですか? : delete me
```
* 「削除」ボタンをクリック

* DBクラスターに含まれる **最後のDBインスタンスを削除する場合** 、以下の手順で削除します。
  * 「サイドバー」→「インスタンス」→ DBインスタンス横のラジオボタンをクリック→「インスタンスの操作」メニュー→「削除」→ 「XXXXX インスタンス を削除しますか?」ダイアログへ
```
最終スナップショットを作成しますか？ : いいえ
インスタンスの削除後、システムスナップショットとポイントインタイムの復元を含む自動バックアップが利用不可となることを了承しました。: チェックボックスをチェック
削除を確認するには、delete me というフレーズを以下のフィールドに入力します : delete me
```
* 「削除」ボタンをクリック

* 3つのDBインスタンスのステータスが **"削除中"** になっていれば正常です。削除されるまで6分程度要します。
## お疲れ様でした。これでハンズオンは終了です。
