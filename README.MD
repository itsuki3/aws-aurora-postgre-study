# Amazon Redshift ハンズオン - Day1

# 1. 環境構築準備
## 1-0. ハンズオンで利用するアカウント
* AWSプロフェッショナルサービスにて用意した以下のアカウントをご利用下さい。

|no.|アカウントID|IAMユーザー|管理者|
|---:|:---|:---|:---|
|1|196063562359|handsonuser|AWS仲谷|
|2|661677603911|handsonuser|AWS仲谷|
|3|165722896290|handsonuser|AWS仲谷|
|4|889444526632|handsonuser|AWS関口|
|5|492965105526|handsonuser|AWS関口|
|6|830011738705|handsonuser|AWS関口|

* パスワードは当日お知らせします。

## 1-1. ハンズオン向けコンテンツの取得
* 今回使用するCloudFormationテンプレート（URL）、SQL等は、本マークダウン中から直接コピーして下さい。

## 1-2. CloudFormationによるハンズオン環境の構築
### 1-2-1. VPC
* 以下の手順でCloudFormationスタックを作成します。
  * 「サービス」 → 「CloudFormation」 → 「スタックの作成」→
  * 「新しいスタックの作成」ボタン →　
  * 「Amazon S3 テンプレート URL の指定」チェックボックス →
    *　以下を指定 https://s3-ap-northeast-1.amazonaws.com/my-bucket-4-handson/Cfn/xsr-version/vpc.yml
```
スタックの名前   : vpcXXXXX　(XXXXXは任意の文字列、3~5文字程度)　
Env Type      :Dev
Project Name  :任意
```
  * 「次へ」ボタン →　オブション入力画面はデフォルトのまま「次へ」ボタン　→
  * 確認画面　→　「作成」ボタン
* ステータスが "CREATE_COMPLETE"　になるまで待ちます。
* 以下のスタックが構築されます。
```
vpcXXXXX-ランダムな文字列
```

### 1-2-2. Redshift
* VPCの作成が完了したら、同様の手順でRedshiftクラスター用のCloudFormationスタックを作成します。
  * 「サービス」 → 「CloudFormation」 → 「スタックの作成」→
  * 「新しいスタックの作成」ボタン →　
  * 「Amazon S3 テンプレート URL の指定」チェックボックス →
    * 以下を指定　https://s3-ap-northeast-1.amazonaws.com/my-bucket-4-handson/Cfn/xsr-version/redshift.yml
```
スタックの名前     : redshiftXXXXX　(XXXXXは任意の文字列、3~5文字程度)　
Env Type        : Dev
Project Name    : 任意
Common Password : xxxxxx (8文字以上、半角英数字大文字小文字いずれも１文字以上含む)を入力　→
```
  * 「次へ」ボタン →　オブション入力画面はデフォルトのまま「次へ」ボタン　→
  *  確認画面の最下部の「AWS CloudFormation によってカスタム名のついた IAM リソースが作成される場合があることを承認します。」チェックボックスをチェック　→　「作成」ボタン
  * ***パスワードは後で使用しますので、記録しておいて下さい***

* ステータスが "CREATE_COMPLETE"　になるまで待ちます。
* 以下のスタックが構築されます。
```
redshiftXXXXX-ランダムな文字列
```

# 2. 接続確認

## 2-1. Management Console（MC）からデータベースの状態を確認
* 「サービス」→「Redshift」→「クラスター」タブに移動します。
* クラスターが作成されていることを確認します。
* 「クラスター」→当該クラスターをクリックすると、そのクラスターに移動して詳細情報を閲覧できます。「設定」タブ、「ステータス」タブをクリックして、それぞれどのような情報が表示されるか確認してみて下さい。

## 2-2. データベースへの接続確認
### 2-2-1 接続設定の作成
* PC上にインストールされている、Aginity Workbench for Redshift（以下Aginity）を起動します。
* 接続情報を以下の通り入力します。
```
Name      : （任意）
Server    : （クラスターエンドポイントのURL。ポートを除く）
DB Port   : 5439
SSL Mode  : Prefer
User ID   : awsuser
Password  : （上記で入力したパスワード）
```
* Redshiftクラスターのエンドポイント名は、**2-1.**に記載のクラスター詳細情報から探してみて下さい。

### 2-2-2 接続とテスト
* 入力した接続情報に基づいて、実際にRedshiftクラスターに接続します。
* 接続したら、Aginityからawsuser.mydbスキーマをクリックし、pg_catarogデータベースをざっと外観してみて下さい。
  * ここにはシステムテーブル（STL_XXX）やシステムビュー（STV_XXX、SVV_XXX）が格納されており、運用にあたってこれらのテーブルやビューは度々参照することになります。

# 3. ハンズオン
* ここでは、Redshiftの基本的な使い方についてハンズオンを行っていきます。
  * **sh1**という1,500万件ほどの小型のスキーマをサンプルに使っていきます。

## 3-1. COPYの実行
* COPYコマンドを実行し、Redshiftクラスターにsh1スキーマのデータを投入します。
```
入力するコマンドなど(コピペで可能な様に）
```

## 3-2. メンテナンストラック、パラメーターグループ設定、WLM設定の閲覧
* COPYコマンドを実行し、Redshiftクラスターにsh1スキーマのデータを投入します。
```
入力するコマンドなど(コピペで可能な様に）
```

## 3-3. クエリーの実行
* SQLを実行し、sh1スキーマに投入したデータを確認します。
```
入力するコマンドなど(コピペで可能な様に）
```

## 3-4. COPYおよびクエリーの実行状況の確認
* コンソールを使って、COPYおよびクエリーの実行状況を確認します。

### 3-4-1 COPY（ロード）の実行確認
* COPYコマンドの実行結果は、「クラスター」→（クラスター名）→「ロード」タブから確認できます。
  * タブをクリックして、先程実行したクエリーを確認してみて下さい。
  * 当該クエリーをクリックすると詳細を見ることができます。

### 3-4-2 クエリーの実行確認
* クエリーの実行結果は、「クラスター」→（クラスター名）→「クエリ」タブから確認できます。
  * タブをクリックして、先程実行したクエリーを確認してみて下さい。
  * 当該クエリーをクリックすると詳細を見ることができます。

### 3-4-3 クラスターの性能情報確認
* 「クラスター」→（クラスター名）→「クラスターのパフォーマンス」からクラスターのハードウェア性能情報、同じく「データベースのパフォーマンス」からクエリー性能情報を確認できます。
  * タブをクリックして、先程実行したクエリー時間帯の性能情報を確認してみて下さい。
  * 「いずれも、CloudWatchから得られたメトリクス情報を元にしています。

## 3-5. バックアップの取得
* Redshiftのバックアップはスナップショットに依拠しており、自動と手動があります。
  * 自動スナップショットは8時間ごとまたは更新5GBごとに取得されます（いずれか早い方）。
  * 手動スナップショットはバッチの断面等で任意に取得できます。
* 本環境では手動スナップショットが想定されていますので、手動スナップショットを作成します。
  * 「スナップショット」→「スナップショットの作成」→
```
クラスター識別子    : 作成したクラスターの識別子
スナップショット識別子 : 任意
```
* 当該スナップショットをクリックし、作成状況やサイズを確認します。
  * スナップショットの作成にはしばらくかかります（通常は自動スナップショットからの差分ですが、今回は基底となる自動スナップショットがないため）ので、状況を確認いただければ先に進んでいただいて結構です。

## 3.6. イベントの閲覧
* 「イベント」→「イベント」をクリックし、以下のフィルタリング条件を入力して、当該クラスターに関係したイベントのみを出力します。
```
フィルター : クラスター
文字列   : 作成したクラスター名（部分一致で可）
```
* 「イベント」→「サブスクリプション」→「イベントサブスクリプションの作成」をクリックし、新規イベントサブスクリプションを作成します。
  * サブスクリプションは、カテゴリー、重要度、リソース（クラスターなど）を指定した上で、イベント発生時にAmazon SNS経由で通知する仕組みです。
  * ここでは模擬的に、直接メールを送信する設定を行いますが、実際には作成しません。
```
カテゴリ     :　全てのカテゴリーを選択
重要度      :　エラー
ソースタイプ  :　すべて
名前        : 任意（4文字以上）
有効        :　はい

新しいトピックの作成を選択
名前        :　任意
送信先メール  :　任意
```
* 全ての項目を設定したら、**キャンセル**をクリックして画面を抜けます。

## 3.7. リストア
### 3.7.1 リストアの実行とクエリーの実行
* TBD

### 3.7.2. テーブルレベルの復元
* TBD


## 4. ハンズオン環境の削除
* ハンズオン環境の削除は弊社にて行います。ここでは何もしなくて構いません。

### お疲れ様でした！

# Amazon Aurora PostgreSQL ハンズオン - Day1

# 1. 環境構築準備
## 1-0. ハンズオンで利用するアカウント
* AWSプロフェッショナルサービスにて用意した以下のアカウントをご利用下さい。

|no.|アカウントID|IAMユーザー|管理者|
|---:|:---|:---|:---|
|1|196063562359|handsonuser|AWS仲谷|
|2|661677603911|handsonuser|AWS仲谷|
|3|165722896290|handsonuser|AWS仲谷|
|4|889444526632|handsonuser|AWS関口|
|5|492965105526|handsonuser|AWS関口|
|6|830011738705|handsonuser|AWS関口|

* パスワードは当日お知らせします。

## 1-1. ハンズオン向けコンテンツの取得

```
利用するデータやスクリプトのダウンロード
```

# 2. ハンズオン
* Amazon Redshiftハンズオンの1-2. CloudFormationによるハンズオン環境の構築で作成したスタックの一部を利用しAurora PostgreSQLクラスターの作成から基本的な操作を体験していただきます。

# 2-1. Aurora PostgreSQLクラスターの作成
* 特に記載のない選択箇所、入力箇所については、何も出ずデフォルトが選択されていることをご確認ください。

```
「サービス」→「RDS」→「データベースの作成」→「エンジンの選択」
→「Amazon Aurora」ラジオボタン→「PostgreSQL対応」ラジオボタン
→「次へ」ボタン→「DBエンジンのバージョン」ドロップダウンメニュー
→”Aurora PostgreSQL (compatible with PostgreSQL 9.6.8)を選択
→「DBインスタンスクラス」ドロップダウンメニュー→"db.r4.large - 2 vcpu, 15.25 GiB RAM"を選択
→「DBインスタンス識別子」→"aup96-handson"を入力
→「マスターユーザの名前」→ 英数字でお好きなユーザー名を入力（設定したユーザーを控えておいてください）
→「マスターパスワード」、「パスワードの確認」に同じパスワードを設定（入力したパスワードは忘れないようご注意ください。）
→「次へ」ボタン
```

```
「Virtual Priavate Cloud (VPC)」ドロップダウンメニュー
→ "デフォルト VPC" を選択
→「サブネット」ドロップダウンメニュー→ "default" を選択
→「アベイラビリティゾーン」ドロップダウンメニュー→"ap-northwest-1a"　を選択
→「DBクラスター識別子」→ "aup96-handson" を入力
→「データベースの名前」→ "aup96-handson" を入力
→「削除保護」チェックボックを外す
→「データベースも作成」ボタン
→「DBインスタンスの詳細表示」→インスタンスタブ
```

* インスタンスタブで2つのDBインスタンスのステータスが"作成中"から"利用可能"に変化するまで待ちます。（10分程度）

* 各DBインスタンス名のリンクをクリックして、詳細情報を確認してみてください。Replicationペインでは、2つのDBインスタンスが、書き込み(Writer)なのか、読み込み(Reader)なのかを確認することができます。また、各DBインスタンスのエンドポイント等も確認することができます。

* 「サービス」→「RDS」→サイドバーの「クラスター」→クラスタータブに移動します。
* クラスターが作成され、「状況」が"利用可能"になっていることを確認します。
* 作成されているDBクラスター識別子のリンクをクリックして、クラスターの詳細情報を確認してみてください。クラスターエンドポイント、読み込みエンドポイント等の詳細情報を確認できます。確認したエンドポイントをメモ帳などにコピーしておいてください。接続設定の作成で利用します。

## 2-1-2. アクセス元の制限

```
「サービス」→「RDS」→「インスタンス」
→「インスタンス」ペイン→「DBインスタンス」
→ リストされている2つのDBのいずれか一つのリンクをクリック
```

```
「接続」ペイン
→「セキュリティグループ」の「タイプ」が "inbound"となっているセキュリティグループのリンクをクリックしてEC2ダッシューボードページへ移動
```

```
「セキュリティグループ」ペインの「インバウンド」タブ→「編集」ボタン
→「インバウンドルールの編集」ダイアログの「タイプ」が"PostgreSQL"となっているルールの「ソース」列
→「マイIP」→「保存」ボタン
```
* （この操作で、Aurora PostgreSQLの各インスタンスは、現在捜査中のPCのIPアドレスからのアクセスのみ受け付けるようになります）


## 2-2. データベースへの接続確認
### 2-2-1 接続設定の作成
* PC常にインストールされている Psqledit を起動します。クラスターエンドポイント向け接続設定と読み込みエンドポイント向け接続設定の２つの設定を作成してください。
* 接続設定に必要な情報は以下の通り

PsqlEditにて、クラスターエンドポイント向けログイン情報を入力します。
```
USER : (クラスター作成時に入力したマスターユーザー名)
PASS : (クラスター作成時に入力したマスターユーザーのパスワード)
DBNAME : aup96-handson
HOST : (クラスターエンドポイントを指定します)
PORT : 5432
NAME : クラスターエンドポイント
```

PsqlEditにて、クラスターエンドポイント向けログイン情報を入力します。
```
USER : (クラスター作成時に入力したマスターユーザー名)
PASS : (クラスター作成時に入力したマスターユーザーのパスワード)
DBNAME : aup96-handson
HOST : (読み込みエンドポイントを指定します)
PORT : 5432
NAME : 読み込みエンドポイント
```


### 2-2-2 接続とテスト
* 2-2-1で作成したクラスターエンドポイント接続設定と、読み込みエンドポイント向け接続設定、ぞれぞれの情報に基づいて、実際に各エンドポイントに接続できるか確認します。



## 2-3. クラスターエンドポイントからの接続
* 2-2-1で作成したクラスターエンドポイント接続設定を利用して接続し、以下の操作を行います。
* 以下のコマンド、DDL、SQL文を実行し、クラスターエンドポイントから表作成、データ登録など書き込み操作が行えることを確認します。書き込み操作の確認が済んだらデータベースからdisconnectします。

```
create schema hoge;
set search_path=hoge;
select current_schema();
create table foobar (
  id numeric not null primary key
  ,name character(20) not null
  ,description character varying(40)
);
insert into foobar values(1,'test','test insertion');
select * from foobar;
```

## 2-4. 読み込みエンドポイントからの接続
* 2-2-1で作成した読み込みエンドポイント接続設定を利用して接続し、以下の操作を行います。
* 以下のクエリーを実行してみてください。何が起こりましたか？

```
select current_schema();
set search_path=hoge;
select current_schema();
select * from foobar;
```

* 以下のクエリーを実行してみてください。何が起こりましたか？

```
insert into foobar values(1,'test','test insertion');
```
* 読み込みエンドポイントへの接続時は、読み込み操作しか行えません。

## 2-5. スナップショットの取得
* 手動で取得したスナップショツトはデータベースを完全に削除した場合でも削除されません。

```
「サイドバー」→「 インスタンス」→ プライマリーインスタンスとなっているDBインスタンス名横のラジオボタンをクリック（プライマリーインスタンスであるかを確認するには、DBインスタンスのリンクをクリックし、Replicationペインのロールが書き込みになっているインスタンスを確認します）
→「インスタンスの操作」ドロップダウンメニュー→「スナップショットの取得」を選択
→「DBスナップショットの取得」ペイン→「スナップショット名」に
→ "handson-aurora-snapshot"を入力
→「スナップショットの取得」ボタンをクリック。
```

* スナップショットの取得の終わりを待っている間、次の操作を行なっています。

## 2-6. レプリカの追加

```
「サイドバー」→「 インスタンス」→ プライマリーインスタンスとなっているDBインスタンス名横のラジオボタンをクリック（プライマリーインスタンスであるかを確認するには、DBインスタンスのリンクをクリックし、Replicationペインのロールが書き込みになっているインスタンスを確認します）
→「インスタンスの操作」ドロップダウンメニュー→「Auroraレプリカの作成」
→「レプリカの作成」ベイン→「設定」ペイン→"ap96-handson-replica2"
→「Auroraの作成」
```

* 追加作成したレプリカのステータが、”利用可能中”に変わるのを待ちます

```
「サイドバー」→「クラスター」→「DBクラスターメンバー」ペイン
```

* 追加したDBインスタンス"ap96-handson-replica2"がレプリカリストに追加され、ロールが"読み込み"になっていることが確認できます

## 2-7. レプリカの削除

```
「サイドバー」→「インスタンス」
→ 2-6で追加した"ap96-handson-replica2"インスタンスリンク横のラジオボタンをクリック
→「インスタンスの操作」ドロップダウンメニュー→「削除」
→ delete me というフレーズをテキストボックスに入力→「削除」ボタン
```

* インスタンスペインで、"ap96-handson-replica2"インスタンスのステータスが”削除中”になったことを確認してください。
* 削除したしたインスタンスが削除されるまで待ちます。(6〜7分程度)

## 2-8. クラスターの停止

```
「サイドバー」→「クラスター」
→DBクラスター横のラジオボタンをクリックして停止するクラスターを選択
→「クラスターアクション」→「停止」→「データベースの停止」
```

* Amazon RDSも含め、インスタンスの停止は可能ですが、停止可能な期間は7日間です。8日後には自動的に再起動します。
* クラスターの状況が"停止中"から"停止"になるまでしばらく待ちます。（10分程度）

## 2-9. クラスターの開始

```
「サイドバー」→「クラスター」→DBクラスター横のラジオボタンをクリックして開始するクラスターを選択
→「クラスターアクション」→「開始」
```

* クラスターの状況が"開始中"から"利用可能"になるまでしばらく待ちます。（15分程度）

## 2-10. クラスター内の全DBインスタンスの削除
* プライマリーインスタンンス(Writer)を削除します

```
「サイドバー」→「インスタンス」→DBインスタンス横のラジオボタンをクリックして削除するDBインスタンスを選択
→「インスタンスの操作」→ テキストボックスへ  delete me  を入力
→「削除」ボタン
```

* 残りのDBインスタンスを削除します

```
「サイドバー」→「インスタンス」
→DBインスタンス横のラジオボタンをクリックして削除するDBインスタンスを選択
→「インスタンスの操作」
→ 「最終スナップショットを作成しますか？ドロップダウンメニュー」→”いいえ”
→ 「インスタンスの削除後、システムスナップショットとポイントインタイムの復元を含む自動バックアップが利用不可となることを了承しました。」チェックボックス
→ テキストボックスへ  delete me  を入力→「削除」ボタン
```

* 2つのDBインスタンスが削除されるまで待ちます。（6分程度）

## 2-11. リストア
* 2-5. で取得したスナップショットからDBインスタンスを復元します。

```
「サイドバー」→「スナップショット」→ 2-5.で取得したスナップショットを選択
→「スナップショットのアクション」→「スナップショットの復元」
→「DBインスタンスクラス」ドロップダウンメニュー
→"db.r4.large - 2 vcpu, 15.25 GiB RAM"を選択
→「DBインスタンス識別子」→"aup96-handson"を入力
→「DBインスタンスの復元」ボタン
```

* DBインスタンスが復元されるまで待ちます。（15分程度）
* スナップショットから復元されるDBインスタンスは1インスタンスのみです。
* プライマリーインスタンスのみが含まれるクラスターが復元されます。
* レプリカはベットを追加作成する必要があります。
* クラスターの停止・開始機能のリリースにより、開発環境など利用しない時間帯にクラスターの停止開始の代替操作としてのクラスターの削除、リストア、レプリカ追加という煩雑な操作は不要になりました。

## お疲れ様でした。これでハンズオンは終了です。

## この操作はお時間に余裕のある場合のみ実施をお願いいたします。
## ハンズオン環境の削除
* ハンズオン環境の削除は弊社にて行います。ここでは何もしなくて構いません。
