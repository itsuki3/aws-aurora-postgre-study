# Amazon Redshift ハンズオン - Day1

# 1. 環境構築準備
## 1-0. ハンズオンで利用するアカウント
* TBD
```
TBD
```

## 1-1. ハンズオン向けコンテンツの取得
```
利用するデータやスクリプトのダウンロード
```

## 1-2. CloudFormationによるハンズオン環境の構築
* 「サービス」 → 「CloudFormation」 → 「スタックの作成」→
* 「新しいスタックの作成」ボタン →　
* 「Amazon S3 テンプレート URL の指定」チェックボックス →
*  https://<your_workshop_bucket>.s3.amazonaws.com/master.yaml を入力　→
*  スタックの名前 : aws-XXXX-study　(XXXXはユーザー名)　を入力　→
*  MasterUserPass : xxxxxx (8文字以上、半角英数字大文字小文字いずれも１文字以上含む)を入力　→
* 「次へ」ボタン →　オブション入力画面はデフォルトのまま「次へ」ボタン　→
*  確認画面の最下部の「AWS CloudFormation によってカスタム名のついた IAM リソースが作成される場合があることを承認します。」チェックボックスをチェック　→　「作成」ボタン
* ステータスが "CREATE_COMPLETE"　になるまで待ちます

**以下のスタックが構築されます:**
```
aws-XXXX-study-SecurityGroupStack-XXXXXXXXXXXXX [NESTED]
aws-XXXX-study-IAMStack-XXXXXXXXXXXX [NESTED]
aws-XXXX-study-VPCStack-XXXXXXXXXXXX [NESTED]
aws-XXXX-study
```

# 2. 接続確認

## 2-1. Management Console（MC）からデータベースの状態を確認
* 「サービス」→「Redshift」→「クラスター」タブに移動します。
* クラスターが作成されていることを確認します。
* 「クラスター」→当該クラスターをクリックすると、そのクラスターに移動して詳細情報を閲覧できます。「設定」タブ、「ステータス」タブをクリックして、それぞれどのような情報が表示されるか確認してみて下さい。

## 2-2. データベースへの接続確認
### 2-2-1 接続設定の作成
* PC上にインストールされている、Aginity Workbench for Redshiftを起動します。
* 接続情報を以下の通り入力します。
```
TBD
```
* Redshiftクラスターのエンドポイント名は、**2-1.**に記載のクラスター詳細情報から探してみて下さい。

### 2-2-2 接続とテスト
* 入力した接続情報に基づいて、実際にRedshiftクラスターに接続します。
```
TBD
```

# 3. ハンズオン
ここでは、Redshiftの基本的な使い方についてハンズオンを行っていきます。

## 3-1. COPYの実行
* TBD

```
入力するコマンドなど(コピペで可能な様に）
```

## 3-2. メンテナンストラック、パラメーターグループ設定、WLM設定の閲覧
* TBD

```
入力するコマンドなど(コピペで可能な様に）
```

## 3-3. クエリーの実行
* TBD

```
入力するコマンドなど(コピペで可能な様に）
```
## 3-4. COPYおよびクエリーの実行状況の確認

### 3-4-1 COPY（ロード）の実行確認
* TBD

### 3-4-2 クエリーの実行確認
* TBD

### 3-4-3 クラスターの性能情報確認
* TBD

## 3-5. バックアップの取得
* TBD

## 3.6. イベントの閲覧
* TBD

## 3.7. リストア
### 3.7.1 リストアの実行とクエリーの実行
* TBD

### 3.7.2. テーブルレベルの復元
* TBD


## 4. ハンズオン環境の削除
* TBD






# Amazon Aurora PostgreSQL ハンズオン - Day1

# 1. 環境構築準備
## 1-0. ハンズオンで利用するアカウント
* TBD

```
TBD
```

## 1-1. ハンズオン向けコンテンツの取得

```
利用するデータやスクリプトのダウンロード
```

# 2. ハンズオン
* Amazon Redshiftハンズオンの1-2. CloudFormationによるハンズオン環境の構築で作成したスタックの一部を利用しAurora PostgreSQLクラスターの作成から基本的な操作を体験していただきます。

# 2-1. Aurora PostgreSQLクラスターの作成
* 特に記載のない選択箇所、入力箇所については、何も出ずデフォルトが選択されていることをご確認ください。

```
「サービス」→「RDS」→「データベースの作成」→「エンジンの選択」
→「Amazon Aurora」ラジオボタン→「PostgreSQL対応」ラジオボタン
→「次へ」ボタン→「DBエンジンのバージョン」ドロップダウンメニュー
→”Aurora PostgreSQL (compatible with PostgreSQL 9.6.8)を選択
→「DBインスタンスクラス」ドロップダウンメニュー→"db.r4.large - 2 vcpu, 15.25 GiB RAM"を選択
→「DBインスタンス識別子」→"aup96-handson"を入力
→「マスターユーザの名前」→"hogehoge"を入力
→「マスターパスワード」、「パスワードの確認」に同じパスワードを設定（入力したパスワードは忘れないようご注意ください。）
→「次へ」ボタン
```

```
「Virtual Priavate Cloud (VPC)」ドロップダウンメニュー
→ "デフォルト VPC" を選択
→「サブネット」ドロップダウンメニュー→ "default" を選択
→「アベイラビリティゾーン」ドロップダウンメニュー→"ap-northwest-1a"　を選択
→「DBクラスター識別子」→ "aup96-handson" を入力
→「データベースの名前」→ "aup96-handson" を入力
→「削除保護」チェックボックを外す
→「データベースも作成」ボタン
→「DBインスタンスの詳細表示」→インスタンスタブ
```

* インスタンスタブで2つのDBインスタンスのステータスが"作成中"から"利用可能"に変化するまで待ちます。（10分程度）

* 各DBインスタンス名のリンクをクリックして、詳細情報を確認してみてくてください。Replicationペインでは、2つのDBインスタンスが、Writerなのか、Readerなのか確を認することができます。また、各DBインスタンスの Instance Endpoint等なども確認することができます。

* 「サービス」→「RDS」→サイドバーの「クラスター」→クラスタータブに移動します。
* クラスターが作成され、「状況」が"利用可能"になっていることを確認します。
* 作成されているDBクラスター識別子のリンクをクリックして、クラスターの詳細情報を確認してみてください。Cluster Endpoint、Reader Endpointなどの詳細情報が確認できます。確認したEndpointをメモ帳などにコピーしておいてください。接続設定の作成で利用します。

## 2-1-2. アクセス元の制限

```
「サービス」→「RDS」→「インスタンス」
→「インスタンス」ペイン→「DBインスタンス」
→ リストされている2つのDBのいずれか一つのリンクをクリック
```

```
「接続」ペイン
→「セキュリティグループ」の「タイプ」が "inbound"となっているセキュリティグループのリンクをクリックしてEC2ダッシューボードページへ移動
```

```
「セキュリティグループ」ペインの「インバウンド」タブ→「編集」ボタン
→「インバウンドルールの編集」ダイアログの「タイプ」が"PostgreSQL"となっているルールの「ソース」列
→「マイIP」→「保存」ボタン
```
* （この操作で、Aurora PostgreSQLの各インスタンスは、現在捜査中のPCのIPアドレスからのアクセスのみ受け付けるようになります）


## 2-2. データベースへの接続確認
### 2-2-1 接続設定の作成
* PC常にインストールされている Psqledit を起動します。Cluster Endpoint向け接続設定とWrite Endpoint向け接続設定の２つの設定を作成してください。
* 接続設定に必要な情報は以下の通り

```
  2-1. でコピーした Cluster Endpointと Writer Endpoint と Port番号
  2-1. で入力したマスターユーザー　と　パスワード
```

### 2-2-2 接続とテスト
* 作成したWriter Endpoint接続設定と、Reader Endpoint向け接続設定、ぞれぞれの情報に基づいて、実際に各エンドポイントに接続します。

```
TBD
```

## 2-3. Cluster Endpoint(Writer Endpoint)からの接続
* 2-2-1で作成したCluster Endpointに接続して以下の操作を行います。
* 以下のコマンド、DDL、SQL文を実行し、Cluster Endpointから表作成、データ登録など書き込み操作が行えることを確認します。書き込み操作の確認できたらデータベースからdisconnectします。

```
create schema hoge;
set search_path=hoge;
select current_schema();
create table foobar (
  id numeric not null primary key
  ,name character(20) not null
  ,description character varying(40)
);
insert into foobar values(1,'test','test insertion');
select * from foobar;
```

## 2-4. Reader Endpointからの接続
* 2-2-1で作成したReader Endpointに接続して以下の操作を行います。
* 以下のクエリーを実行してみてください。何が起こりましたか？

```
select current_schema();
set search_path=hoge;
select current_schema();
select * from foobar;
```

* 以下のクエリーを実行してみてください。何が起こりましたか？

```
insert into foobar values(1,'test','test insertion');
```
* 接続先は、Reader Instanceであるためクエリーしか実行できません。

## 2-5. スナップショットの取得
* 手動で取得したスナップショツトはデータベースを完全に削除した場合でも削除されません。

```
「サイドバー」→「 インスタンス」→ Primary Instanceリンク横のラジオボタンをクリック
→「インスタンスの操作」ドロップダウンメニュー→「スナップショットの取得」を選択
→「DBスナップショットの取得」ペイン→「スナップショット名」に
→ "handson-aurora-snapshot"を入力
→「スナップショットの取得」ボタンをクリック。
```

* スナップショットの取得の終わりを待っている間、次の操作を行なっています。

## 2-6. Replicaの追加(Readerの追加)

```
「サイドバー」→「 インスタンス」→ Primary Instanceリンク横のラジオボタンをクリック
→「インスタンスの操作」ドロップダウンメニュー→「Auroraレプリカの作成」
→「レプリカの作成」ベイン→「設定」ペイン→"ap96-handson-replica2"
→「Auroraの作成」
```

* 追加作成したReader Instanceのステータが、”利用可能中”に変わるのを待ちます

```
「サイドバー」→「クラスター」→「DBクラスターメンバー」ペイン
```

* 追加したDBインスタンス"ap96-handson-replica2"がレプリカリストに追加され、ロールが"読み込み"になっていることが確認できます

## 2-7. Replicaの削除(Readerの削除)

```
「サイドバー」→「インスタンス」
→ 2-6で追加した"ap96-handson-replica2"インスタンスリンク横のラジオボタンをクリック
→「インスタンスの操作」ドロップダウンメニュー→「削除」
→ delete me というフレーズをテキストボックスに入力→「削除」ボタン
```

* インスタンスペインで、"ap96-handson-replica2"インスタンスのステータスが”削除中”になったことを確認してください。
* 削除したしたインスタンスが削除されるまで待ちます。(6〜7分程度)

## 2-8. Clusterの停止

```
「サイドバー」→「クラスター」
→DBクラスター横のラジオボタンをクリックして停止するクラスターを選択
→「クラスターアクション」→「停止」→「データベースの停止」
```

* Amazon RDSも含め、インスタンスの停止は可能ですが、停止可能な期間は7日間です。8日後には自動的に再起動します。
* クラスターの状況が"停止中"から"停止"になるまでしばらく待ちます。（10分程度）

## 2-9. Clusterの開始

```
「サイドバー」→「クラスター」→DBクラスター横のラジオボタンをクリックして開始するクラスターを選択
→「クラスターアクション」→「開始」
```

* クラスターの状況が"開始中"から"利用可能"になるまでしばらく待ちます。（15分程度）

## 2-10. クラスター内の全DBインスタンスの削除
* Primary Instance (Writer)を削除します

```
「サイドバー」→「インスタンス」→DBインスタンス横のラジオボタンをクリックして削除するDBインスタンスを選択
→「インスタンスの操作」→ テキストボックスへ  delete me  を入力
→「削除」ボタン
```

* 残りのDBインスタンスを削除します

```
「サイドバー」→「インスタンス」
→DBインスタンス横のラジオボタンをクリックして削除するDBインスタンスを選択
→「インスタンスの操作」
→ 「最終スナップショットを作成しますか？ドロップダウンメニュー」→”いいえ”
→ 「インスタンスの削除後、システムスナップショットとポイントインタイムの復元を含む自動バックアップが利用不可となることを了承しました。」チェックボックス
→ テキストボックスへ  delete me  を入力→「削除」ボタン
```

* 2つのDBインスタンスが削除されるまで待ちます。（6分程度）

## 2-11. リストア
* 2-5. で取得したスナップショットからDBインスタンスを復元します。

```
「サイドバー」→「スナップショット」→ 2-5.で取得したスナップショットを選択
→「スナップショットのアクション」→「スナップショットの復元」
→「DBインスタンスクラス」ドロップダウンメニュー
→"db.r4.large - 2 vcpu, 15.25 GiB RAM"を選択
→「DBインスタンス識別子」→"aup96-handson"を入力
→「DBインスタンスの復元」ボタン
```

* DBインスタンスが復元されるまで待ちます。（15分程度）
* スナップショットから復元されるDBインスタンスは1インスタンスのみです。Reader兼用のPrimary Instanceのみを含むクラスターが復元されます。
* 別途Replicaを作成ひつようがあります。クラスターの停止・開始機能のリリースにより、開発環境など利用しない時間帯にクラスターの停止開始の代替操作としてのクラスターの削除、リストア、レプリカ追加という煩雑な操作は不要になりました。

## お疲れ様でした。これでハンズオンは終了です。

## この操作はお時間に余裕のある場合のみ実施をお願いいたします。
## ハンズオン環境の削除
* ## 2-10. と同じ手順でクラスター内の全DBインスタンスを削除してください。
* "削除中"というステータスになった状態でMCからログアウトしていただいて構いません。
